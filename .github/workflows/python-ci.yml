name: Python CI + Plots + Pages

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ".:./src"
      MPLBACKEND: Agg
    steps:
      - uses: actions/checkout@v4
      - run: '[ -f src/__init__.py ] || touch src/__init__.py'
      - uses: actions/setup-python@v5
        with: { python-version: "3.12", cache: "pip" }
      - run: |
          pip install --upgrade pip
          pip install pytest numpy pandas matplotlib
      - run: pytest -q

  run-and-artifacts:
    needs: tests
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ".:./src"
      MPLBACKEND: Agg
    steps:
      - uses: actions/checkout@v4
      - run: '[ -f src/__init__.py ] || touch src/__init__.py'
      - uses: actions/setup-python@v5
        with: { python-version: "3.12", cache: "pip" }
      - run: |
          pip install --upgrade pip
          pip install numpy pandas matplotlib
      - name: Run TSP GA and save plots
        run: |
          python - <<'PY'
          import pathlib, random
          import numpy as np
          from src.main import (
              carregar_instancia, evoluir,
              plot_melhor_rota, plot_convergencia,
              PONTOS_FILENAME, MATRIZ_FILENAME, SEMENTE
          )
          random.seed(SEMENTE); np.random.seed(SEMENTE)
          tsp = carregar_instancia(f"data/{PONTOS_FILENAME}", f"data/{MATRIZ_FILENAME}")
          rota, custo, hist = evoluir(tsp)
          outdir = pathlib.Path("artifacts"); outdir.mkdir(exist_ok=True)
          plot_melhor_rota(tsp, rota, custo, save_as=str(outdir / "melhor_rota.png"))
          plot_convergencia(hist, save_as=str(outdir / "convergencia.png"))
          (outdir / "index.html").write_text(
              "<h1>Resultados</h1>"
              f"<p>Melhor custo: {custo:.4f}</p>"
              '<img src="melhor_rota.png"><br><img src="convergencia.png">',
              encoding="utf-8"
          )
          PY
      - name: Upload GA artifacts (NOT pages)
        uses: actions/upload-artifact@v4
        with:
          name: tsp-plots
          path: artifacts/*
          if-no-files-found: error
          retention-days: 14

  build-pages:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [ tests, run-and-artifacts ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare site/
        run: |
          cp data/index.html site/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy-pages:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
